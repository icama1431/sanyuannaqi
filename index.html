<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å…ƒç´æ°£åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            touch-action: none;
        }

        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            transition: transform 0.1s ease-out;
        }

        /* å›ºå®šæº–å¿ƒç·š (æ‰‹æ©ŸæŒ‡å‘å‰æ–¹) */
        .crosshair {
            position: absolute;
            top: -15px;
            left: 50%;
            width: 2px;
            height: 330px;
            background: rgba(234, 179, 8, 0.3);
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: none;
        }
        .crosshair::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #eab308;
        }

        .compass-disk {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid #334155;
            background: #0f172a;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.1, 0.1, 0.25, 1);
        }

        .gua-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform-origin: center;
        }

        .gua-label {
            margin-top: 40px;
            font-size: 1.15rem;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .gua-line {
            position: absolute;
            top: 0;
            left: 50%;
            width: 1px;
            height: 50%;
            background: rgba(255,255,255,0.1);
            transform: translateX(-50%);
        }

        .needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 130px;
            background: linear-gradient(to bottom, #ef4444 50%, #f8fafc 50%);
            transform: translate(-50%, -100%);
            z-index: 20;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: background 0.3s;
            pointer-events: none;
        }

        .needle.is-final { background: #ef4444 !important; }

        .building-marker {
            position: absolute;
            top: -12px;
            left: 50%;
            width: 20px;
            height: 20px;
            color: #fbbf24;
            z-index: 40;
            filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.8));
            transition: transform 0.3s cubic-bezier(0.1, 0.1, 0.25, 1);
        }

        /* ç¾…ç›¤ä¸­å¿ƒæŒ‰éˆ•æ¨£å¼ */
        .center-action-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 86px;
            height: 86px;
            border-radius: 50%;
            background: rgba(234, 179, 8, 0.95);
            border: 4px solid #0f172a;
            color: #0f172a;
            font-weight: 900;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
            z-index: 100;
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.5);
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px;
        }

        .center-action-btn:active {
            transform: translate(-50%, -50%) scale(0.9);
            background: #fbbf24;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .wang { background-color: #059669; color: white; } /* æ—ºæ°£ï¼šç¶ è‰² */
        .shuai { background-color: #dc2626; color: white; } /* è¡°æ°£ï¼šç´…è‰² */

        .permission-overlay {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }

        #simulation-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 50;
        }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <header class="text-center mb-2">
        <h1 class="text-2xl font-bold text-amber-400">ä¸‰å…ƒç´æ°£åŠ©æ‰‹</h1>
        <p class="text-[10px] tracking-widest text-slate-500 uppercase font-bold">ä¸‹å…ƒä¹é‹åˆ¤å®šå°ˆç”¨ (2024-2043)</p>
    </header>

    <!-- é€²åº¦æ­¥é©Ÿ -->
    <div class="flex justify-between mb-4 px-8 relative">
        <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-800 -z-10"></div>
        <div class="flex flex-col items-center">
            <div id="step-dot-1" class="w-7 h-7 rounded-full bg-amber-500 flex items-center justify-center font-bold text-slate-900 border-2 border-slate-900 transition-colors">1</div>
            <span class="text-[10px] mt-1 font-bold text-slate-400">å¤§æ¨“</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="step-dot-2" class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center font-bold text-slate-500 border-2 border-slate-900 transition-colors">2</div>
            <span class="text-[10px] mt-1 font-bold text-slate-400">å–®å…ƒ</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="step-dot-3" class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center font-bold text-slate-500 border-2 border-slate-900 transition-colors">3</div>
            <span class="text-[10px] mt-1 font-bold text-slate-400">åˆ¤å®š</span>
        </div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-start pt-4 relative">
        <p id="instruction" class="text-xs text-center mb-6 text-slate-300 px-4 h-12 flex items-center justify-center">è«‹é»æ“Šç¾…ç›¤ä¸­å¿ƒå•Ÿå‹•æ„Ÿæ‡‰å™¨...</p>

        <div class="compass-container">
            <div class="crosshair"></div>
            <div id="building-pointer" class="hidden building-marker">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z"/></svg>
            </div>
            
            <!-- ä¸­å¿ƒæŒ‰éˆ• -->
            <div id="main-btn" onclick="handleMainAction()" class="center-action-btn">
                å•Ÿå‹•<br>æ„Ÿæ‡‰
            </div>

            <div id="compass-disk" class="compass-disk">
                <svg id="disk-bg" viewBox="0 0 100 100" class="w-full h-full">
                    <!-- JS ç”Ÿæˆæ‰‡å€ -->
                </svg>
                <div id="gua-layer" class="gua-container"></div>
            </div>
            <div id="compass-needle" class="needle"></div>
        </div>

        <!-- æ•¸æ“šå¡ç‰‡ -->
        <div class="mt-12 grid grid-cols-2 gap-4 w-full max-w-xs">
            <div id="azimuth-card" class="bg-slate-800/80 p-3 rounded-xl text-center border border-slate-700 shadow-lg">
                <div class="text-slate-500 text-[10px] mb-1">æ–¹ä½è§’ Azimuth</div>
                <div id="current-deg" class="text-lg font-mono font-bold text-amber-400">0Â°</div>
            </div>
            <div id="trigram-card" class="bg-slate-800/80 p-3 rounded-xl text-center border border-slate-700 shadow-lg">
                <div class="text-slate-500 text-[10px] mb-1">å¦ä½ Trigram</div>
                <div id="current-gua" class="text-lg font-bold text-white">--</div>
            </div>
            <div id="status-container" class="col-span-2 flex justify-center mt-2 opacity-0 transition-opacity">
                <span id="gua-status" class="status-badge">--</span>
            </div>
        </div>
        
        <div class="mt-6">
            <button onclick="resetAll()" class="text-slate-500 text-[10px] font-medium uppercase tracking-widest px-6 py-2 border border-slate-800 rounded-full hover:bg-slate-800 transition-colors">é‡ç½®æ‰€æœ‰è³‡æ–™ Reset</button>
        </div>
    </div>

    <!-- æ¬Šé™é®ç½© -->
    <div id="permission-overlay" class="fixed inset-0 z-[200] permission-overlay flex items-center justify-center p-8 hidden text-center">
        <div class="max-w-xs bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-2xl">
            <div class="text-4xl mb-4">ğŸ§­</div>
            <h2 class="text-2xl font-bold mb-4 text-amber-400">å•Ÿå‹•æ„Ÿæ‡‰å™¨</h2>
            <p class="text-slate-400 mb-8 text-sm leading-relaxed">è«‹æˆæ¬Šè£ç½®æŒ‡å—é‡æ¬Šé™ï¼Œä»¥é€²è¡Œä¸‰å…ƒç´æ°£ç²¾ç¢ºåˆ¤å®šã€‚</p>
            <button onclick="requestPermission()" class="w-full bg-amber-500 text-slate-900 font-bold py-4 rounded-xl text-lg">æˆæ¬Šä¸¦å•Ÿå‹•</button>
        </div>
    </div>

    <!-- æ¨¡æ“¬æ¸¬è©¦ -->
    <div id="simulation-bar" class="opacity-10 hover:opacity-100 transition-opacity">
        <span class="text-white text-[9px] whitespace-nowrap opacity-60">é›»è…¦æ¨¡æ“¬:</span>
        <input type="range" min="0" max="360" value="0" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500" oninput="simulateHeading(this.value)">
        <span id="sim-val" class="text-amber-400 font-mono text-[10px] w-6 text-right">0</span>
    </div>

    <script>
        /**
         * ä¸‹å…ƒä¹é‹ (2024-2043) æ—ºåº¦é‚è¼¯ï¼š
         * æ—ºæ°£ (Prosperous): é›¢(å—)ã€ä¹¾(è¥¿åŒ—)ã€è‰®(æ±åŒ—)ã€å…Œ(è¥¿)
         * è¡°æ°£ (Declining): å(åŒ—)ã€å¤(è¥¿å—)ã€éœ‡(æ±)ã€å·½(æ±å—)
         */
        const Period9Config = {
            "å": { status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "è‰®": { status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "éœ‡": { status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "å·½": { status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "é›¢": { status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "å¤": { status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "å…Œ": { status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "ä¹¾": { status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' }
        };

        const GuaOrder = ["å", "è‰®", "éœ‡", "å·½", "é›¢", "å¤", "å…Œ", "ä¹¾"];
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        let currentHeading = 0, buildingAngle = null, unitOffset = 0, lockedDiskRotation = 0, step = 0; 
        let sensorActive = false, lastAppliedRotation = 0, lastAppliedMarkerRotation = 0;

        function initCompassUI() {
            const guaLayer = document.getElementById('gua-layer'), bgSvg = document.getElementById('disk-bg');
            guaLayer.innerHTML = ''; bgSvg.innerHTML = '';
            GuaOrder.forEach((name, i) => {
                const angle = i * 45;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                // ç•«å‡ºä¸€å€‹ 45 åº¦çš„åœ“å¼§æ‰‡å€
                path.setAttribute("d", `M 50 50 L 50 0 A 50 50 0 0 1 85.35 14.65 Z`);
                path.setAttribute("fill", Period9Config[name].color);
                // æ¯å€‹æ‰‡å€æ—‹è½‰ angle-22.5 åº¦ï¼Œè®“å¦ä½ä¸­å¿ƒå°æº– angle
                path.setAttribute("transform", `rotate(${angle-22.5}, 50, 50)`);
                bgSvg.appendChild(path);
                
                const item = document.createElement('div');
                item.className = 'gua-item';
                item.style.transform = `rotate(${angle}deg)`;
                item.innerHTML = `
                    <div class="gua-line"></div>
                    <div class="gua-label" style="transform:rotate(${-angle}deg)">${name}</div>
                `;
                guaLayer.appendChild(item);
            });
        }

        // è™•ç†è·¨è¶Š 0/360 åº¦çš„å¹³æ»‘æ—‹è½‰
        function getShortestRotation(target, current) {
            let diff = (target - (current % 360));
            if (diff > 180) diff -= 360; 
            if (diff < -180) diff += 360;
            return current + diff;
        }

        function updateHeading(val) {
            currentHeading = (val + 360) % 360;
            let diskTarget = 0;
            const needle = document.getElementById('compass-needle');

            if (step === 0) {
                // åˆå§‹éšæ®µï¼šéš¨æŒ‡å—é‡æ—‹è½‰
                diskTarget = -currentHeading;
            } else if (step === 1) {
                // ç¬¬ä¸€éšæ®µé–å®šå¤§æ¨“ï¼šç›¤é¢å›ºå®šåœ¨æ‰‹æ©Ÿè¢å¹•
                diskTarget = lockedDiskRotation;
            } else if (step === 2) {
                // ç¬¬äºŒéšæ®µåŒæ­¥å–®å…ƒï¼šæ¢å¾©å‹•æ…‹å¹³è¡¡
                diskTarget = unitOffset - currentHeading;
            }

            lastAppliedRotation = getShortestRotation(diskTarget, lastAppliedRotation);
            document.getElementById('compass-disk').style.transform = `rotate(${lastAppliedRotation}deg)`;
            
            if (step >= 1) {
                const marker = document.getElementById('building-pointer');
                lastAppliedMarkerRotation = getShortestRotation(buildingAngle - currentHeading, lastAppliedMarkerRotation);
                marker.style.transform = `translateX(-50%) rotate(${lastAppliedMarkerRotation}deg)`;
            }

            document.getElementById('current-deg').innerText = `${Math.round(currentHeading)}Â°`;
            
            let evalAngle = currentHeading;
            if (step === 2) {
                evalAngle = (currentHeading - unitOffset + 360) % 360;
            } else if (step === 1) {
                evalAngle = (currentHeading - buildingAngle + 360) % 360;
            }
            
            const info = getGuaInfo(evalAngle);
            document.getElementById('current-gua').innerText = info.name;
            
            if (step === 2) {
                document.getElementById('status-container').style.opacity = "1";
                const badge = document.getElementById('gua-status');
                badge.innerText = `ä¹é‹ï¼š${info.status}æ°£`;
                badge.className = `status-badge ${info.status === 'æ—º' ? 'wang' : 'shuai'}`;
                needle.classList.add('is-final');
            }
        }

        function getGuaInfo(deg) {
            let normalized = (deg + 22.5) % 360;
            let idx = Math.floor(normalized / 45);
            const name = GuaOrder[idx];
            return { name, status: Period9Config[name].status };
        }

        function handleMainAction() {
            if (!sensorActive) { requestPermission(); return; }
            if (step === 0) { 
                buildingAngle = currentHeading; 
                lockedDiskRotation = -currentHeading; 
                step = 1; 
                document.getElementById('building-pointer').classList.remove('hidden');
            } else if (step === 1) { 
                unitOffset = lockedDiskRotation + currentHeading; 
                step = 2; 
            } else resetAll();
            updateUI();
            updateHeading(currentHeading);
        }

        function resetAll() {
            step = 0; buildingAngle = null; unitOffset = 0; lockedDiskRotation = 0;
            document.getElementById('building-pointer').classList.add('hidden');
            document.getElementById('status-container').style.opacity = "0";
            document.getElementById('compass-needle').classList.remove('is-final');
            document.getElementById('azimuth-card').classList.remove('hidden');
            document.getElementById('trigram-card').classList.remove('col-span-2');
            updateUI();
        }

        async function requestPermission() {
            if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const res = await DeviceOrientationEvent.requestPermission();
                    if (res === 'granted') sensorSuccess();
                    else alert("æ„Ÿæ‡‰å™¨æˆæ¬Šè¢«æ‹’çµ•ã€‚");
                } catch (e) { alert("æˆæ¬Šç™¼ç”ŸéŒ¯èª¤ï¼š" + e); }
            } else sensorSuccess();
        }

        function sensorSuccess() {
            sensorActive = true;
            document.getElementById('permission-overlay').classList.add('hidden');
            const ev = isIOS ? 'deviceorientation' : 'deviceorientationabsolute';
            window.addEventListener(ev, e => {
                let h = isIOS ? e.webkitCompassHeading : (360 - e.alpha);
                if (h !== undefined) updateHeading(h);
            }, true);
            updateUI();
        }

        function simulateHeading(v) { 
            sensorActive = true; 
            document.getElementById('sim-val').innerText = v;
            updateHeading(parseFloat(v)); 
        }

        function updateUI() {
            const btn = document.getElementById('main-btn'), ins = document.getElementById('instruction');
            const dots = [1,2,3].map(i => document.getElementById(`step-dot-${i}`));
            const cls = { act: "bg-amber-500 text-slate-900", done: "bg-green-600 text-white", idle: "bg-slate-800 text-slate-500" };
            
            if (!sensorActive) { 
                btn.innerHTML = "é»æ“Š<br>æˆæ¬Š";
                ins.innerText = "è«‹é»æ“Šä¸­å¿ƒæŒ‰éˆ•æˆæ¬Šæ„Ÿæ‡‰å™¨..."; 
                document.getElementById('permission-overlay').classList.remove('hidden');
                return; 
            }
            if (step === 0) {
                ins.innerText = "å°æº–å»ºç¯‰å¤§é–€æ­£å‰æ–¹ (å‘å¤–)ï¼Œé»æ“Šä¸­å¿ƒé–å®šã€‚";
                btn.innerHTML = "é–å®š<br>å¤§æ¨“";
                dots[0].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.act}`;
                dots[1].className = dots[2].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.idle}`;
            } else if (step === 1) {
                ins.innerText = "åŸºæº–å·²å›ºå®šã€‚ç§»å‹•åˆ°å–®å…ƒé–€å°æº–å‰æ–¹ï¼Œé»æ“ŠåŒæ­¥ã€‚";
                btn.innerHTML = "åŒæ­¥<br>å–®å…ƒ";
                dots[0].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.done}`;
                dots[1].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.act}`;
                dots[2].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.idle}`;
            } else {
                ins.innerText = "åˆ¤å®šç›¤å·²å°±ç·’ã€‚æ–¹ä½è§’éš±è—ï¼Œè«‹è½‰å‹•æ‰‹æ©ŸæŸ¥çœ‹æ°£å£ã€‚";
                btn.innerHTML = "é‡æ–°<br>æ¸¬é‡";
                dots[0].className = dots[1].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.done}`;
                dots[2].className = `w-7 h-7 rounded-full flex items-center justify-center font-bold border-2 border-slate-900 ${cls.act}`;
                document.getElementById('azimuth-card').classList.add('hidden');
                document.getElementById('trigram-card').classList.add('col-span-2');
            }
        }
        window.onload = () => { initCompassUI(); updateUI(); };
    </script>
</body>
</html>
