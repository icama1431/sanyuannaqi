<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å…ƒç´æ°£é¢¨æ°´åŠ©æ‰‹ | San Yuan Qi Intake Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            touch-action: none;
        }

        .compass-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto;
            transition: transform 0.1s ease-out;
        }

        /* å¤–éƒ¨å›ºå®šæº–å¿ƒç·š (æ‰‹æ©ŸæŒ‡å‘) */
        .crosshair {
            position: absolute;
            top: -20px;
            left: 50%;
            width: 2px;
            height: 360px;
            background: rgba(234, 179, 8, 0.3);
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: none;
        }
        .crosshair::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #eab308;
        }

        .compass-disk {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid #334155;
            background: #0f172a;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden;
            /* å¹³æ»‘æ—‹è½‰éæ¸¡ */
            transition: transform 0.2s cubic-bezier(0.1, 0.1, 0.25, 1);
        }

        .gua-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .gua-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform-origin: center;
        }

        .gua-label {
            margin-top: 45px;
            font-size: 1.25rem;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .gua-line {
            position: absolute;
            top: 0;
            left: 50%;
            width: 1px;
            height: 50%;
            background: rgba(255,255,255,0.2);
            transform: translateX(-50%);
        }

        .needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 140px;
            background: linear-gradient(to bottom, #ef4444 50%, #f8fafc 50%);
            transform: translate(-50%, -100%);
            z-index: 30;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .building-marker {
            position: absolute;
            top: -15px;
            left: 50%;
            width: 24px;
            height: 24px;
            color: #fbbf24;
            z-index: 40;
            filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.8));
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wang { background-color: #059669; color: white; box-shadow: 0 0 15px rgba(5, 150, 105, 0.4); }
        .shuai { background-color: #dc2626; color: white; box-shadow: 0 0 15px rgba(220, 38, 38, 0.4); }
        
        #error-msg {
            display: none;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 15px;
            line-height: 1.4;
        }

        /* åŠé€æ˜é»‘è‰²é®ç½© */
        #permission-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(6px);
        }

        .step-label {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <header class="text-center mb-4">
        <h1 class="text-2xl font-bold text-amber-400">ä¸‰å…ƒç´æ°£åŠ©æ‰‹</h1>
        <p class="text-[10px] tracking-widest text-slate-500 uppercase font-bold">San Yuan Qi Intake Assistant</p>
        <p class="text-xs text-slate-400 mt-1 font-light">ä¸‹å…ƒä¹é‹ (2024-2043) | Period 9</p>
    </header>

    <!-- Progress Steps -->
    <div class="flex justify-between mb-6 px-8 relative">
        <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-800 -z-10"></div>
        <div class="flex flex-col items-center">
            <div id="step-dot-1" class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-slate-900 border-4 border-slate-900 transition-colors">1</div>
            <span class="step-label">å¤§æ¨“ Building</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="step-dot-2" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center font-bold text-slate-500 border-4 border-slate-900 transition-colors">2</div>
            <span class="step-label">å–®å…ƒ Unit</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="step-dot-3" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center font-bold text-slate-500 border-4 border-slate-900 transition-colors">3</div>
            <span class="step-label">åˆ¤å®š Result</span>
        </div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center">
        <p id="instruction" class="text-sm text-center mb-6 text-slate-300 px-4 h-12 flex items-center justify-center">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•æ¸¬é‡...</p>

        <!-- Compass Area -->
        <div class="compass-container">
            <div class="crosshair"></div>
            <div id="building-pointer" class="hidden building-marker">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z"/></svg>
            </div>
            
            <div id="compass-disk" class="compass-disk">
                <svg id="disk-bg" viewBox="0 0 100 100" class="w-full h-full transform -rotate-[112.5deg]">
                    <!-- JS Generated Background Sectors -->
                </svg>
                <div id="gua-layer" class="gua-container"></div>
            </div>
            <!-- æŒ‡é‡å§‹çµ‚æŒ‡å‘è¢å¹•ä¸Šæ–¹ (æ‰‹æ©Ÿæ­£å‰æ–¹) -->
            <div class="needle"></div>
        </div>

        <!-- Real-time Display -->
        <div class="mt-10 grid grid-cols-2 gap-4 w-full max-w-xs">
            <div class="bg-slate-800/80 p-3 rounded-xl border border-slate-700 text-center">
                <div class="text-slate-500 text-xs mb-1">æ–¹ä½è§’ Azimuth</div>
                <div id="current-deg" class="text-xl font-mono font-bold text-amber-400">0Â°</div>
            </div>
            <div class="bg-slate-800/80 p-3 rounded-xl border border-slate-700 text-center">
                <div class="text-slate-500 text-xs mb-1">å¦ä½ Trigram</div>
                <div id="current-gua" class="text-xl font-bold">--</div>
            </div>
            <div id="status-container" class="col-span-2 flex justify-center mt-2 opacity-0 transition-opacity">
                <span id="gua-status" class="status-badge">--</span>
            </div>
        </div>
        
        <div id="error-msg" class="max-w-xs text-center"></div>
    </div>

    <!-- Main Buttons -->
    <div class="mt-auto pb-8 space-y-4">
        <button id="main-btn" onclick="handleMainAction()" class="w-full bg-amber-500 hover:bg-amber-600 active:scale-95 transition-all text-slate-900 font-bold py-4 rounded-2xl shadow-xl text-lg">
            å•Ÿå‹•è®€å– Start Tracking
        </button>
        <button onclick="resetAll()" class="w-full text-slate-500 text-sm font-medium">é‡ç½®æ‰€æœ‰æ•¸æ“š Reset Data</button>

        <!-- Semi-transparent Permission Overlay -->
        <div id="permission-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-8 hidden text-center">
            <div class="max-w-xs bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-2xl">
                <div class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-3xl">ğŸ§­</span>
                </div>
                <h2 class="text-2xl font-bold mb-2">å•Ÿç”¨æ„Ÿæ¸¬å™¨</h2>
                <p class="text-xs tracking-widest text-slate-500 mb-6 uppercase font-bold">Sensor Permission</p>
                <p class="text-slate-400 mb-8 text-sm leading-relaxed">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä»¥å•Ÿç”¨è£ç½®æŒ‡å—é‡ï¼Œé€™å°‡å¹«åŠ©æˆ‘å€‘åˆ¤æ–·ç²¾ç¢ºçš„ç´æ°£æ–¹å‘ã€‚</p>
                <button onclick="requestPermission()" class="w-full bg-amber-500 text-slate-900 font-bold py-4 rounded-xl shadow-lg text-lg">æˆæ¬Šä¸¦é–‹å•Ÿ Allow</button>
            </div>
        </div>
    </div>

    <!-- Simulation for non-mobile testing -->
    <div class="fixed bottom-0 left-0 w-full p-2 bg-black/40 text-[10px] flex items-center gap-2 opacity-30 hover:opacity-100 transition-opacity">
        <span class="text-white">æ¨¡æ“¬è½‰å‘ Sim:</span>
        <input type="range" min="0" max="360" value="0" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="simulateHeading(this.value)">
    </div>

    <script>
        // ä¹é‹æ—ºæ°£æ–¹ï¼šå—(é›¢)ã€è¥¿åŒ—(ä¹¾)ã€æ±åŒ—(è‰®)ã€è¥¿(å…Œ)
        const Period9Config = {
            "å": { angle: 0, status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "è‰®": { angle: 45, status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "éœ‡": { angle: 90, status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "å·½": { angle: 135, status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "é›¢": { angle: 180, status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "å¤": { angle: 225, status: 'è¡°', color: 'rgba(220, 38, 38, 0.2)' },
            "å…Œ": { angle: 270, status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' },
            "ä¹¾": { angle: 315, status: 'æ—º', color: 'rgba(5, 150, 105, 0.4)' }
        };

        const GuaOrder = ["å", "è‰®", "éœ‡", "å·½", "é›¢", "å¤", "å…Œ", "ä¹¾"];
        
        let currentHeading = 0;
        let buildingAngle = null;
        let unitOffset = 0;
        let step = 0; 
        let sensorActive = false;
        let sensorDataReceived = false;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

        function initCompassUI() {
            const guaLayer = document.getElementById('gua-layer');
            const bgSvg = document.getElementById('disk-bg');
            guaLayer.innerHTML = '';
            bgSvg.innerHTML = '';

            GuaOrder.forEach((name, i) => {
                const angle = i * 45;
                const config = Period9Config[name];
                
                // ç•«èƒŒæ™¯æ‰‡å€
                const x1 = 50 + 50 * Math.cos(Math.PI * 0 / 180);
                const y1 = 50 + 50 * Math.sin(Math.PI * 0 / 180);
                const x2 = 50 + 50 * Math.cos(Math.PI * 45 / 180);
                const y2 = 50 + 50 * Math.sin(Math.PI * 45 / 180);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M 50 50 L ${x1} ${y1} A 50 50 0 0 1 ${x2} ${y2} Z`);
                path.setAttribute("fill", config.color);
                path.setAttribute("transform", `rotate(${angle}, 50, 50)`);
                bgSvg.appendChild(path);

                // ç•«å¦ä½æ–‡å­—
                const item = document.createElement('div');
                item.className = 'gua-item';
                item.style.transform = `rotate(${angle}deg)`;
                item.innerHTML = `<div class="gua-line"></div><div class="gua-label" style="transform:rotate(${-angle}deg)">${name}</div>`;
                guaLayer.appendChild(item);
            });
        }

        function updateHeading(val) {
            sensorDataReceived = true;
            document.getElementById('error-msg').style.display = 'none';
            currentHeading = (val + 360) % 360;
            
            let diskRotation = 0;

            if (step === 0) {
                // åˆå§‹ç‹€æ…‹ï¼šç¾…ç›¤è·Ÿéš¨æ‰‹æ©Ÿæ—‹è½‰ (Fixed to phone)
                diskRotation = 0;
            } 
            else if (step === 1) {
                // ç¬¬ä¸€éšæ®µï¼šé–å®šå¤§æ¨“å¾Œé€²å…¥ã€Œåå‘å‹•æ…‹å¹³è¡¡ã€
                // ç›¤é¢åœ¨ç‰©ç†ç©ºé–“å›ºå®šï¼Œå§‹çµ‚æŒ‡å‘å¤§æ¨“æ­£é¢
                diskRotation = buildingAngle - currentHeading;
            } 
            else if (step === 2) {
                // ç¬¬äºŒéšæ®µï¼šåŒæ­¥å–®å…ƒå¾Œæ¢å¾©ã€Œç¾…ç›¤å¯ä»¥è½‰å‹•ã€
                // æ­¤æ™‚ç›¤é¢å›ºå®šåœ¨æ‰‹æ©Ÿè¢å¹•ä¸Šï¼Œé¡¯ç¤ºè¨ˆç®—å¾Œçš„å–®å…ƒç›¤
                // ç›¤é¢ç›¸å°æ–¼æ‰‹æ©Ÿçš„åç§»ç”± unitOffset æ±ºå®š
                diskRotation = -unitOffset; 
            }

            const disk = document.getElementById('compass-disk');
            disk.style.transform = `rotate(${diskRotation}deg)`;
            
            // æ›´æ–°å¤§æ¨“æ¨™è¨˜ (å§‹çµ‚ç›¸å°æ–¼ç›¤é¢ä½ç½®)
            if (step >= 1) {
                const marker = document.getElementById('building-pointer');
                // æ¨™è¨˜åœ¨ç¾…ç›¤ä¸­çš„å›ºå®šè§’åº¦
                marker.style.transform = `translateX(-50%) rotate(${buildingAngle - currentHeading}deg)`;
            }

            // æ›´æ–°æ•¸æ“šé¡¯ç¤º
            document.getElementById('current-deg').innerText = `${Math.round(currentHeading)}Â°`;
            
            // å¦ä½åˆ¤å®š logic: 
            // åœ¨ Step 2 æ™‚ï¼Œæˆ‘å€‘éœ€è¦åˆ¤å®šçš„æ˜¯æ‰‹æ©Ÿç›®å‰å°æº–çš„æ–¹å‘åœ¨ã€Œå–®å…ƒç›¤ã€ä¸­æ˜¯å“ªå€‹å¦ä½
            let evaluationAngle = currentHeading;
            if (step === 2) {
                // ä¿®æ­£åˆ¤å®šè§’åº¦ï¼šå–®å…ƒé–€è½‰å‘æ™‚ï¼Œå°æº–çš„è§’åº¦éœ€è£œå„Ÿå»ºç¯‰ç›¤çš„åç§»
                evaluationAngle = (currentHeading - unitOffset + 360) % 360;
            }
            
            const info = getGuaInfo(evaluationAngle);
            document.getElementById('current-gua').innerText = info.name;
            
            if (step === 2) {
                const container = document.getElementById('status-container');
                container.style.opacity = "1";
                const badge = document.getElementById('gua-status');
                badge.innerText = `ä¹é‹ï¼š${info.status}æ°£`;
                badge.className = `status-badge ${info.status === 'æ—º' ? 'wang' : 'shuai'}`;
            }
        }

        function getGuaInfo(deg) {
            let normalized = (deg + 22.5) % 360;
            let idx = Math.floor(normalized / 45);
            const name = GuaOrder[idx];
            return { name, status: Period9Config[name].status };
        }

        function handleMainAction() {
            if (!sensorActive) { requestPermission(); return; }
            if (step === 0) lockBuilding();
            else if (step === 1) syncUnit();
            else resetAll();
        }

        function lockBuilding() {
            buildingAngle = currentHeading;
            step = 1;
            document.getElementById('building-pointer').classList.remove('hidden');
            updateUI();
        }

        function syncUnit() {
            // è¨ˆç®—å–®å…ƒèˆ‡å»ºç¯‰çš„ç›¸å°åå·®ï¼Œä¸¦å›ºå®šæœ€çµ‚ç›¤é¢
            unitOffset = currentHeading - buildingAngle;
            step = 2;
            updateUI();
        }

        function resetAll() {
            step = 0; buildingAngle = null; unitOffset = 0;
            document.getElementById('building-pointer').classList.add('hidden');
            document.getElementById('status-container').style.opacity = "0";
            updateUI();
        }

        async function requestPermission() {
            const errorEl = document.getElementById('error-msg');
            errorEl.style.display = 'none';

            if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const res = await DeviceOrientationEvent.requestPermission();
                    if (res === 'granted') sensorSuccess();
                    else errorEl.innerHTML = "æ¬Šé™æˆæ¬Šè¢«æ‹’çµ•ã€‚";
                } catch (e) { 
                    errorEl.innerHTML = `æ¬Šé™éŒ¯èª¤: ${e.message}<br>(Google Sites å¯èƒ½é˜»éš”äº†æ„Ÿæ¸¬å™¨è®€å–)`;
                    errorEl.style.display = 'block';
                }
            } else {
                sensorSuccess();
            }
        }

        function sensorSuccess() {
            sensorActive = true;
            document.getElementById('permission-overlay').classList.add('hidden');
            startTracking();
            setTimeout(() => {
                if (!sensorDataReceived) {
                    const errorEl = document.getElementById('error-msg');
                    errorEl.innerHTML = "è®€å–ä¸åˆ°æ„Ÿæ‡‰å™¨ã€‚è«‹ç¢ºèªï¼š<br>1. ä½¿ç”¨æ‰‹æ©Ÿç€è¦½å™¨<br>2. ç¶²ç«™å…·å‚™ HTTPS å”å®š<br>3. éå…§åµŒæ–¼ç¬¬ä¸‰æ–¹æ¡†æ¶ä¸­";
                    errorEl.style.display = 'block';
                }
            }, 2000);
            updateUI();
        }

        function startTracking() {
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', e => {
                    if (e.alpha !== null) updateHeading(360 - e.alpha);
                }, true);
            } else if ('ondeviceorientation' in window) {
                window.addEventListener('deviceorientation', e => {
                    if (isIOS && e.webkitCompassHeading !== undefined) updateHeading(e.webkitCompassHeading);
                    else if (e.absolute && e.alpha !== null) updateHeading(360 - e.alpha);
                }, true);
            }
        }

        function simulateHeading(v) { 
            sensorActive = true; sensorDataReceived = true;
            document.getElementById('error-msg').style.display = 'none';
            updateHeading(parseFloat(v)); 
        }

        function updateUI() {
            const btn = document.getElementById('main-btn');
            const ins = document.getElementById('instruction');
            const dots = [1,2,3].map(i => document.getElementById(`step-dot-${i}`));
            const cls = { act: "bg-amber-500 text-slate-900", done: "bg-green-600 text-white", idle: "bg-slate-800 text-slate-500" };

            if (!sensorActive) {
                btn.innerText = "é»æ“Šå•Ÿå‹• Start Tracking";
                ins.innerText = "è«‹é»æ“ŠæŒ‰éˆ•æˆæ¬Šæ„Ÿæ‡‰å™¨è®€å–...";
                return;
            }

            if (step === 0) {
                ins.innerText = "è«‹å°æº–å»ºç¯‰å¤§é–€æ­£å‰æ–¹ (å‘å¤–) æŒ‰ä¸‹æŒ‰éˆ•...";
                btn.innerText = "é–å®šå¤§æ¨“æœå‘ Lock Building";
                dots[0].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.act}`;
                dots[1].className = dots[2].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.idle}`;
            } else if (step === 1) {
                ins.innerText = "å¤§æ¨“å®šéŒ¨æˆåŠŸï¼ç¾åœ¨ç›¤é¢å·²å›ºå®šã€‚è«‹ç§»å‹•åˆ°å–®å…ƒé–€å£å°æº–å‰æ–¹æŒ‰ä¸‹åŒæ­¥...";
                btn.innerText = "åŒæ­¥å–®å…ƒé–€ Sync Unit Door";
                dots[0].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.done}`;
                dots[1].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.act}`;
                dots[2].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.idle}`;
            } else {
                ins.innerText = "åˆ†æå®Œæˆï¼ç›®å‰ç¾…ç›¤æ¢å¾©è½‰å‹•ã€‚è«‹å°æº–çª—æˆ¶æŸ¥çœ‹è©²æ–¹ä½ç´æ°£å‰å‡¶ã€‚";
                btn.innerText = "é‡æ–°æ¸¬é‡ Restart";
                dots[0].className = dots[1].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.done}`;
                dots[2].className = `w-8 h-8 rounded-full flex items-center justify-center font-bold border-4 border-slate-900 ${cls.act}`;
            }
        }

        window.onload = () => {
            initCompassUI();
            updateUI();
            if (!isIOS) {
                startTracking();
                setTimeout(() => { if (!sensorDataReceived) document.getElementById('permission-overlay').classList.remove('hidden'); else sensorActive = true; updateUI(); }, 500);
            } else {
                document.getElementById('permission-overlay').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
